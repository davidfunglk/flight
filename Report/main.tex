%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% This template has been downloaded from:
% http://www.LaTeXTemplates.com
%
% Original author:
% WikiBooks (http://en.wikibooks.org/wiki/LaTeX/Title_Creation)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\title{Title page with logo}
%--------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%-------------------------------------------------------------

\documentclass[12pt]{article}
\usepackage[english]{babel}
\usepackage[utf8x]{inputenc}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage[colorinlistoftodos]{todonotes}
\usepackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=cyan,
}
 
\urlstyle{same}

\usepackage{listings}
\usepackage{color}
 
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}
 
\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}
 
\lstset{style=mystyle}

\usepackage{fancyhdr} % Required for custom headers
\usepackage{lastpage} % Required to determine the last page for the footer
\usepackage{extramarks} % Required for headers and footers
\usepackage{lipsum} % Used for inserting dummy 'Lorem ipsum' text into the template
\usepackage{bm}
\usepackage{float}
\usepackage{mathtools}
\usepackage{enumerate}
\usepackage{amssymb}
\usepackage{booktabs}
\usepackage{subcaption}
\usepackage{caption}
\usepackage{graphicx}
\usepackage{enumerate}
\usepackage{multirow}

% Margins
\topmargin=-0.45in
\evensidemargin=0in
\oddsidemargin=0in
\textwidth=6.5in
\textheight=9.0in
\headsep=0.25in 
\linespread{1.1} % Line spacing

% Set up the header and footer
\pagestyle{fancy}
\lhead{}
\chead{Analysis on the Effect of Atlantic Hurricanes on the US Airport Network} % Top center header
\rhead{\firstxmark} % Top right header
\lfoot{\lastxmark} % Bottom left footer
\cfoot{} % Bottom center footer
\rfoot{Page\ \thepage\ of\ \pageref{LastPage}} % Bottom right footer
\renewcommand\headrulewidth{0.4pt} % Size of the header rule
\renewcommand\footrulewidth{0.4pt} % Size of the footer rule

\setlength\parindent{0pt} % Removes all indentation from paragraphs


\begin{document}

\begin{titlepage}

\newcommand{\HRule}{\rule{\linewidth}{0.5mm}} % Defines a new command for the horizontal lines, change thickness here

\center % Center everything on the page
 
%--------------------------------------------------------------
%	HEADING SECTIONS
%--------------------------------------------------------------

\textsc{\LARGE University of California Davis }\\[0.3cm] 
\textsc{\Large Department of Statistics}\\[0.5cm] 
 % Minor heading such as course title

%--------------------------------------------------------------
%	TITLE SECTION
%--------------------------------------------------------------

\HRule \\[0.4cm]
{ \huge \bfseries Practice in Statistical Data Science\\  (STA-160)}\\[0.03cm]
\HRule \\[1.5cm]

\hfill \break \hfill \break \hfill \break
{ \huge \bfseries Analysis on the Effect of Atlantic Hurricanes on the US Airport Network}\\
\hfill \break \hfill \break \hfill \break
\hfill \break

{\large David Fung \\ Yu Chan\\ Jiahui Tan}\\
 
%--------------------------------------------------------------

\vfill % Fill the rest of the page with whitespace

\end{titlepage}

\newpage
\tableofcontents
\newpage
%--------------------------------------------------------------
%Project Start
%--------------------------------------------------------------
\section{Abstract} \label{sec:Abstract}
\section{Introduction} \label{sec:Intro}

\input{./TexFiles/intro.tex}

\section{Description of Data} \label{sec:Descript} 

\subsection{Data Preprocessing}
\input{./TexFiles/DataDescription.tex}

\subsection{Data Exploration}
\input{./TexFiles/DataExploration.tex}

\section{Model} \label{sec:Model}
\input{./TexFiles/Model.tex}

\subsection{Limitations}

\section{Conclusion} \label{sec:Conclusion}

\section{Project Reflections} \label{sec:Reflections}
The biggest challenge we have for this project was actually identifying and clarifying the question we want to answer and why any of this matters. We spend basically 9 out of the 10 weeks changing and revising our project to try to make it meaningful. Even up to the last minute, changes are being made to the project and we are constantly fighting with the question 'why it matters and to who?'. So if we learn anything in these 10 weeks, it was how important it is to have a well-define project to work with.  


\section{Code Appendix} \label{sec:Code Appendix} 
\begin{lstlisting}[language=R, caption=Data Merging in R]
read_data_from_BTS = function(datadir){
  data = read.csv(datadir, stringsAsFactors = FALSE)
  colWanted = c("Year","Quarter","Month","DayofMonth","DayOfWeek","FlightDate",
                "UniqueCarrier","TailNum", "Origin","OriginCityName","OriginState",
                "Dest","DestCityName","DestState","DepTime","CRSDepTime","DepDelay",
                "DepDelayMinutes","DepDel15","DepTimeBlk","TaxiOut","WheelsOff","WheelsOn",
                "TaxiIn","CRSArrTime","ArrTime","ArrDelay","ArrDelayMinutes","ArrDel15",
                "ArrTimeBlk","CRSElapsedTime","ActualElapsedTime","Distance","DistanceGroup","Cancelled","CancellationCode",
                "CarrierDelay","WeatherDelay","NASDelay","SecurityDelay","LateAircraftDelay","Diverted")
  data = data[,colWanted]
  
  #  data = data[data$Origin %in% allAirports & 
  #           data$Dest %in% allAirports,]
  data
}

#Merge GPS Location
getGpsLocation = function(data){
  airports = read.csv("/media/sf_Windows/FlightData/airports.dat",header = FALSE,
                      col.names = c("ID","Name","City","Country","IATA","ICAO",
                                    "Lat","Lon","Altitude","Timezone","DST","Tz","Type","Source"))
  USairports = airports[airports$Country == 'United States',c("IATA", "Lat","Lon","Timezone")]
  finaldf = merge(data, USairports, by.x = 'Origin', by.y = 'IATA', all.x = TRUE)
  names(finaldf)[names(finaldf) %in% c('Lat','Lon','Timezone')] = paste("Origin",c('Lat','Lon','Timezone'))
  finaldf = merge(finaldf, USairports, by.x = 'Dest', by.y = 'IATA', all.x = TRUE)
  names(finaldf)[names(finaldf) %in% c('Lat','Lon','Timezone')] = paste("Dest",c('Lat','Lon','Timezone'))
  # #Fix timezone. Convert UTC offset to US timezone.
  finaldf$`Dest Timezone` = factor(finaldf$`Dest Timezone`)
  levels(finaldf$`Dest Timezone`) = c("US/Hawaii","US/Eastern","US/Central","US/Mountain","US/Pacific","US/Alaska")
  finaldf$`Origin Timezone` = factor(finaldf$`Origin Timezone`)
  levels(finaldf$`Origin Timezone`) = c("US/Hawaii","US/Eastern","US/Central","US/Mountain","US/Pacific","US/Alaska")
  finaldf = finaldf[!is.na(finaldf$`Dest Timezone`) & !is.na(finaldf$`Origin Timezone`),]
  return(finaldf)
}

library(lubridate)
convertToUTC = function(row){
  row[2] = as.numeric(row[2])
  if(nchar(row[2]) == 3)
    row[2] = paste0("0",row[2])
  if(nchar(row[2]) == 2)
    row[2] = paste0("00",row[2])
  if(nchar(row[2]) == 1)
    row[2] = paste0("000",row[2])
  date = paste(row[1:2],collapse = " ")
  return(date)
}

getDistanceFromLatLonInKm = function (lat1,lon1,lat2,lon2) {
  R = 6371;
  dLat = deg2rad(lat2-lat1)
  dLon = deg2rad(lon2-lon1) 
  a = 
    sin(dLat/2) * sin(dLat/2) +
    cos(deg2rad(lat1)) * cos(deg2rad(lat2)) * 
    sin(dLon/2) *sin(dLon/2)
  
  c = 2 * atan2(sqrt(a), sqrt(1-a))
  d = R * c * 0.621371
  return(d)
}

deg2rad = function (deg) {
  return(deg * (pi/180))
}

#Input DataFile
processStorm = function(dataFile) {
  stormdf = read_data_from_BTS(dataFile)

  #Identify Lon and Lat as well as timezone.
  df= getGpsLocation(stormdf)

  df$DepDateTime = apply(df[,c("FlightDate","CRSDepTime")], 1,convertToUTC)

  cols =  paste0("UTC",c("Year", "Month","DayofMonth",
                       "DayOfWeek","DepHour","CRSDepTime"))
  df[cols] = NA

  for(timezone in c("US/Hawaii","US/Eastern","US/Central",
                                                  "US/Mountain","US/Pacific","US/Alaska")){
    date = strptime(df$DepDateTime[df$`Origin Timezone` == timezone], 
                  format="%Y-%m-%d %H%M", tz = timezone)
    date = with_tz(date, tzone = 'UTC')
    newdf = data.frame(Year = year(date),Month = month(date), Day = day(date),
             DayOfWeek = weekdays(date), Hour = hour(date), Time = strftime(date, format="%Y-%m-%d %H:%M:%S"))
    newdf$Time = as.character(newdf$Time)
    newdf$DayOfWeek =as.character(newdf$DayOfWeek)
    df[df$`Origin Timezone` == timezone,cols] = newdf
  }

  #Put time in blocks
  utcTimes = strptime(df$UTCCRSDepTime, format="%Y-%m-%d %H:%M:%S", tz = 'UTC')
  SixHourBlock = cut(utcTimes, breaks = "6 hour")
  df$DepSixHourBlock = SixHourBlock 
  return(df)
}
\end{lstlisting}
\lstlistoflistings
\end{document}